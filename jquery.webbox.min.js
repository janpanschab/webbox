/*
 * jQuery Webbox Plugin - 1.0, 2011/8/5
 * Copyright (c) 2011, Jan Panschab
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *  - http://www.opensource.org/licenses/mit-license.php
 *  - http://www.gnu.org/copyleft/gpl.html
 * 
 * https://github.com/janpanschab/webbox
*/
(function(c){var e,j={overlay:!0,overlayOpacity:0.25,closeOnOverlayClick:!0,position:"absolute",margin:50,loaderDelay:250,width:600,height:600,beforeOpen:function(){},open:function(){},beforeClose:function(){},close:function(){}},a={IMAGE:"image",AJAX:"ajax",IFRAME:"iframe",ANCHOR:"anchor",singleOptions:["wb-position","wb-overlay","wb-iframe","wb-width","wb-height"],storeOptions:{},loaderTimeout:!1,cache:[],group:{},$body:c("body"),$window:c(window),$document:c(document)},b={init:function(d){a.isCreated&&
b.destroy();e=c.extend({},j,d);a.storeOptions=e;a.self=this;a.isCreated=!1;a.isOpen=!1;a.isCreated||b.create();b.bindOpen();b.bindClose();b.bindListing();b.hideAnchors();return this},open:function(d){if(!a.isOpen){a.trigger=d?c(d):this;var d=a.trigger.attr("href"),f=a.trigger.data("wb-options"),g={};f&&(e=c.extend({},e,f));g=b.getSingleDataOptions();e=c.extend({},e,g);a.box.css("position","absolute");e.beforeOpen();b.showLoader();a.contentType=b.getContentType(d);switch(a.contentType){case a.AJAX:case a.IFRAME:case a.ANCHOR:b.openContent(d);
break;case a.IMAGE:b.openImage(d);break;default:b.openImage(d)}}},close:function(){if(a.isOpen)e.beforeClose(),b.unbindWindowResize(),a.contentType===a.ANCHOR&&a.content.children().appendTo(a.trigger.attr("href")),a.contentType===a.IMAGE?a.img.fadeOut(500,function(){c(this).remove()}):a.content.removeClass("wb-content").removeClass("wb-iframe").empty(),a.box.add(a.overlay).fadeOut(500,function(){e.close()}),b.disable(a.prev),b.disable(a.next),b.hideTitle(),b.unbindShortcuts(),e=a.storeOptions,a.isOpen=
!1},next:function(){if(a.group.name!==void 0&&a.group.name!==!1&&a.group.index!==a.group.size-1&&a.isOpen)e=a.storeOptions,b.show(a.group.index+1)},prev:function(){if(a.group.name!==void 0&&a.group.name!==!1&&a.group.index!==0&&a.isOpen)e=a.storeOptions,b.show(a.group.index-1)},openImage:function(d){var f,g;c.when(b.loadImage(d)).done(function(){b.hideLoader();a.box.is(":visible")?(a.img.appendTo(a.content).hide(),a.content.show(),f=b.loadImageDimensions(),f=b.getMaxDimensions(f),g=b.getCenter(f),
c.when(b.resizeBox(f,g)).then(function(){b.setFixedPosition(f);b.setDimensions(a.img,f);a.img.fadeIn(500,function(){b.setListing();a.close.show();b.showTitle();e.open()})})):(a.img.appendTo(a.content),a.content.show(),a.box.fadeIn(500,function(){a.box.focus();b.setListing();b.bindShortcuts();b.bindWindowResize();b.showTitle();e.open()}),e.overlay&&a.overlay.fadeTo(500,e.overlayOpacity),f=b.loadImageDimensions(),f=b.getMaxDimensions(f),b.setDimensions(a.box,f),b.setDimensions(a.img,f),g=b.getCenter(f),
b.setCenter(a.box,g),b.setFixedPosition(f));a.isOpen=!0}).fail(function(){b.hideLoader();c.error("Error loading image "+d)})},openContent:function(d){a.contentType===a.AJAX?c.when(c.ajax({url:d,type:"GET"})).done(function(a){b.contentDone(a)}).fail(function(a,e,h){b.hideLoader();c.error("Error "+a.status+" "+h+" while loading "+d)}):a.contentType===a.IFRAME?c.when(b.loadIframe(d)).done(function(){b.contentDone()}).fail(function(){b.hideLoader();c.error("Error while loading "+d)}):a.contentType===
a.ANCHOR&&(c(d).length?b.contentDone(c(d).children()):c.error("Can't find anchor "+d))},contentDone:function(d){var f;b.hideLoader();a.contentType===a.AJAX||a.contentType===a.ANCHOR?a.content.addClass("wb-content").append(d):a.contentType===a.IFRAME&&a.content.addClass("wb-iframe");a.box.fadeIn(500,function(){b.bindShortcuts();b.bindWindowResize();e.open()});e.overlay&&a.overlay.fadeTo(500,e.overlayOpacity);d=[e.width,e.height];d=b.getMaxDimensions(d);b.setDimensions(a.box,d);f=b.getContentDimensions(d);
b.setDimensions(a.content,f);f=b.getCenter(d);b.setCenter(a.box,f);b.setFixedPosition(d);a.isOpen=!0},setFixedPosition:function(d){e.position==="fixed"&&(d=b.getCenter(d,!0),b.setCenter(a.box,d),a.box.css("position","fixed"))},setAbsolutePosition:function(d){d=b.getCenter(d);b.setCenter(a.box,d);a.box.css("position","absolute")},showTitle:function(){var d=e.title||a.trigger.attr("title"),f=b.getDimensions(a.box)[0];d&&(a.title.width(f).show().children().html(d),a.box.attr("aria-labelledby","wb-title-aria"))},
hideTitle:function(){a.title.hide();a.box.removeAttr("aria-labelledby")},resizeBox:function(d,b){var e=c.Deferred();a.box.animate({top:b[0],left:b[1],width:d[0],height:d[1]},250,e.resolve);return e.promise()},getMaxDimensions:function(a){var f=b.getViewport(e.margin),f=[f[0]/a[0],f[1]/a[1]],f=Math.min(f[0],f[1]);if(f<1)return[parseInt(a[0]*f,10),parseInt(a[1]*f,10)];return a},getContentDimensions:function(d){var b={top:parseInt(a.content.css("marginTop"),10),right:parseInt(a.content.css("marginRight"),
10),bottom:parseInt(a.content.css("marginBottom"),10),left:parseInt(a.content.css("marginLeft"),10)},c={top:parseInt(a.content.css("borderTopWidth"),10),right:parseInt(a.content.css("borderRightWidth"),10),bottom:parseInt(a.content.css("borderBottomWidth"),10),left:parseInt(a.content.css("borderLeftWidth"),10)},e={top:parseInt(a.content.css("paddingTop"),10),right:parseInt(a.content.css("paddingRight"),10),bottom:parseInt(a.content.css("paddingBottom"),10),left:parseInt(a.content.css("paddingLeft"),
10)};return[d[0]-b.left-b.right-c.left-c.right-e.left-e.right,d[1]-b.top-b.bottom-c.top-c.bottom-e.top-e.bottom]},loadImageDimensions:function(){var d;d=a.trigger.data("wb-dimensions");d||(d=b.getDimensions(a.img),a.trigger.data("wb-dimensions",d));return d},getDimensions:function(a){var b=a.is(":visible");b||a.show();var c=[a.width(),a.height()];b||a.hide();return c},setDimensions:function(a,b){a.width(b[0]).height(b[1])},getViewport:function(d){var b=a.$window.width(),c=a.$window.height(),e=2*d;
if(d)return[b-e,c-e];return[b,c]},getScroll:function(){return[a.$document.scrollTop(),a.$document.scrollLeft()]},getCenter:function(a,f){var c=b.getViewport(),h=f?[0,0]:b.getScroll(),i=(c[1]-a[1])/2+h[0],j=(c[0]-a[0])/2+h[1];return[c[1]<a[1]+2*e.margin?e.margin+h[0]:i,c[0]<a[0]+2*e.margin?e.margin+h[1]:j]},setCenter:function(a,b){a.css({top:b[0]+"px",left:b[1]+"px"})},loadImage:function(b){var f=c.Deferred();a.img=c('<img role="img" />');a.img.load(f.resolve).error(f.reject).attr("src",b);return f.promise()},
loadIframe:function(b){var f=c.Deferred();a.iframe=c('<iframe frameborder="0" />');a.iframe.appendTo(a.content).load(f.resolve).attr("src",b);setTimeout(function(){f.resolve()},1E4);return f.promise()},hideContent:function(){var b=c.Deferred();a.content.fadeOut(500,b.resolve);return b.promise()},showLoader:function(){a.trigger.css("cursor","wait");a.loaderTimeout=!0;setTimeout(function(){if(a.loaderTimeout){a.loader.show();a.loaderTimeout=!1;var d=b.getDimensions(a.loader),d=b.getCenter(d,!0);b.setCenter(a.loader,
d)}},e.loaderDelay)},hideLoader:function(){a.trigger.css("cursor","pointer");a.loaderTimeout=!1;a.loader.hide()},tabNavigation:function(b){b.preventDefault();if(a.isOpen){var b=a.box.find(":focus"),f=b.get(0);b.length?f===a.next.get(0)?a.prev.is(":visible")?a.prev.focus():a.close.focus():f===a.prev.get(0)?a.close.focus():f===a.close.get(0)&&(a.next.is(":visible")?a.next.focus():a.prev.is(":visible")&&a.prev.focus()):a.next.is(":visible")?a.next.focus():a.prev.is(":visible")?a.prev.focus():a.close.focus()}},
enter:function(){a.isOpen&&a.box.find(":focus").click()},bindShortcuts:function(){a.$document.bind("keydown.wb",function(a){switch(a.which){case 27:b.close();break;case 37:b.prev();break;case 39:b.next();break;case 9:b.tabNavigation(a);break;case 13:b.enter(a)}})},unbindShortcuts:function(){a.$document.unbind("keydown.wb")},setListing:function(){a.group.name=a.trigger.data("wbGroup")||a.trigger.data("wb-group")||!1;if(a.group.name)a.group.triggers=c(a.self.selector+"[data-wb-group="+a.group.name+
"]"),a.group.index=a.group.triggers.index(a.trigger),a.group.size=a.group.triggers.size(),a.group.size>1&&(a.group.index!==0&&(b.enable(a.prev),b.preload(a.group.triggers.eq(a.group.index-1))),a.group.index!==a.group.size-1&&(b.enable(a.next),b.preload(a.group.triggers.eq(a.group.index+1)))),b.positionArrows()},preload:function(b){b=b.attr("href");if(c.inArray(b,a.cache)===-1)document.createElement("img").src=b,a.cache.push(b)},enable:function(a){a.removeClass("disabled").addClass("enabled").attr("aria-disabled",
!1).show()},disable:function(a){a.removeClass("enabled").addClass("disabled").attr("aria-disabled",!0).hide()},getSingleDataOptions:function(){var b=[];c.each(a.singleOptions,function(f,c){var e=a.trigger.data(c),i=c.replace("wb-","");e!==void 0&&(b[i]=e)});return b},getContentType:function(b){var c=a.AJAX;if(b.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i))c=a.IMAGE;else if(e.iframe)c=a.IFRAME;else if(/^#/.test(b))c=a.ANCHOR;return c},hideAnchors:function(){a.self.each(function(){var a=c(this).attr("href");
/^#/.test(a)&&c(a).hide()})},positionArrows:function(){var b=a.prev.children("span"),c=a.next.children("span"),e=a.box.outerHeight(),h=b.height(),i=c.height();b.css("top",(e-h)/2);c.css("top",(e-i)/2)},show:function(d){a.isOpen=!1;b.disable(a.prev);b.disable(a.next);a.close.hide();b.hideTitle();c.when(b.hideContent()).then(function(){var c=b.getDimensions(a.box);b.setAbsolutePosition(c);a.img.remove();b.open(a.group.triggers.eq(d))})},bindListing:function(){a.prev.add(a.next).bind("click.wb",function(){var d=
this===a.prev.get(0)?a.group.index-1:a.group.index+1;e=a.storeOptions;b.show(d)})},bindOpen:function(){a.$body.delegate(a.self.selector+":not(#wb-close, #wb-prev, #wb-next)","click.wb",function(a){a.preventDefault();b.open(this)})},bindClose:function(){a.close.bind("click.wb",function(){b.close()});b.bindCloseOnOverlayClick()},bindCloseOnOverlayClick:function(){a.overlay.bind("click.wb",function(){e.closeOnOverlayClick&&b.close()})},bindWindowResize:function(){var d,f,g;a.$window.bind("resize.wb",
function(){a.close.hide();b.hideTitle();c.when(b.hideContent()).then(function(){d=a.contentType===a.IMAGE?b.loadImageDimensions():[e.width,e.height];d=b.getMaxDimensions(d);f=b.getCenter(d,e.position==="fixed");c.when(b.resizeBox(d,f)).then(function(){a.contentType===a.IMAGE?b.setDimensions(a.img,d):(g=b.getContentDimensions(d),b.setDimensions(a.content,g));a.content.fadeIn(500);a.close.show();b.showTitle();b.positionArrows()})})})},unbindWindowResize:function(){a.$window.unbind("resize.wb")},create:function(){c('<div id="webbox" role="dialog" tabindex="-1"><div id="wb-content"></div><div id="wb-close" role="button" tabindex="0">\u00d7</div><div id="wb-prev" class="disabled" role="button" aria-disabled="true" tabindex="0"><span>\u00ab</span></div><div id="wb-next" class="disabled" role="button" aria-disabled="true" tabindex="0"><span>\u00bb</span></div><div id="wb-title"><div id="wb-title-aria" /></div></div><div id="wb-loader"><span>\u2605</span></div>').appendTo("body");
a.box=c("#webbox");a.close=c("#wb-close");a.prev=c("#wb-prev");a.next=c("#wb-next");a.content=c("#wb-content");a.title=c("#wb-title");a.loader=c("#wb-loader");if(e.overlay)c('<div id="wb-overlay" />').appendTo("body"),a.overlay=c("#wb-overlay");a.isCreated=!0},destroy:function(){a.box.add(a.overlay).add(a.loader).remove();a.$body.undelegate(".wb");a.$window.unbind(".wb");b.unbindWindowResize();a.isCreated=!1;a.isOpen=!1}};c.fn.webbox=function(a){if(b[a])return b[a].apply(this,Array.prototype.slice.call(arguments,
1));else if(typeof a==="object"||!a)return b.init.apply(this,arguments);else c.error("Method "+a+" does not exist on jQuery webbox plugin")}})(jQuery);