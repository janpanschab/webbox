/**
 * jQuery Webbox Plugin - 1.0.0, 2012/4/5
 * Copyright (c) 2011, Jan Panschab
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *  - http://www.opensource.org/licenses/mit-license.php
 *  - http://www.gnu.org/copyleft/gpl.html
 * 
 * https://github.com/janpanschab/webbox
 */
window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){var c=arguments;c.callee=c.callee.caller;c=[].slice.call(c);"object"===typeof console.log?log.apply.call(console.log,console,c):console.log.apply(console,c)}};
(function(c){function d(){}for(var B="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,time,timeEnd,trace,warn".split(","),w;w=B.pop();)c[w]=c[w]||d})(function(){try{return console.log(),window.console}catch(c){return window.console={}}}());
(function(c){var d,B={overlay:!0,overlayOpacity:0.25,closeOnOverlayClick:!0,position:"absolute",margin:50,loaderDelay:250,width:600,height:600,beforeOpen:function(){},open:function(){},beforeClose:function(){},close:function(){}},w=["wb-position","wb-overlay","wb-iframe","wb-width","wb-height"],q={},C=!1,l=!1,z=!1,E=[],r,m,x,t,F=c("body"),y=c(window),A=c(document),i,h,g,k,f,n,u,j,o,p,D,G,v,b={init:function(a){d=c.extend({},B,a);i=this.selector;q[i]={};q[i].options=d;q[i].self=this;C||(b.create(),
b.bindClose(),b.bindListing());b.bindOpen();b.hideAnchors();return this},open:function(a){if(l)console.warn("Webbox is already open. Possible reason - Webbox is attached twice to one trigger.");else{h=a?c(a):this;var a=h.attr("href"),e=h.data("wb-options"),s={};d=q[i].options;e&&(d=c.extend({},d,e));s=b.getlocalDataOptions();d=c.extend({},d,s);g.css("position","absolute");d.beforeOpen();b.showLoader();k=b.getContentType(a);switch(k){case "ajax":case "iframe":case "anchor":b.openContent(a);break;case "image":b.openImage(a);
break;default:b.openImage(a)}}},close:function(){l&&(d.beforeClose(),b.unbindWindowResize(),"anchor"===k&&f.children().appendTo(h.attr("href")),"image"===k?n.fadeOut(500,function(){c(this).remove()}):f.removeClass("wb-content").removeClass("wb-iframe").empty(),c.when(g.fadeOut(500),u.fadeOut(500)).done(function(){d.close();d=q[i].options;l=!1}),b.disable(j),b.disable(o),b.hideTitle(),b.unbindShortcuts())},next:function(){void 0!==r&&!1!==r&&m!==x-1&&l&&(d=q[i].options,b.show(m+1))},prev:function(){void 0!==
r&&!1!==r&&0!==m&&l&&(d=q[i].options,b.show(m-1))},openImage:function(a){var e,s;l=!0;c.when(b.loadImage(a)).done(function(){b.hideLoader();g.is(":visible")?(n.appendTo(f).hide(),f.show(),e=b.loadImageDimensions(),e=b.getMaxDimensions(e),s=b.getCenter(e),c.when(b.resizeBox(e,s)).then(function(){b.setFixedPosition(e);b.setDimensions(n,e);n.fadeIn(500,function(){b.setListing();p.show();b.showTitle();d.open()})})):(n.appendTo(f),f.show(),g.fadeIn(500,function(){g.focus();b.setListing();b.bindShortcuts();
b.bindWindowResize();b.showTitle();d.open()}),d.overlay&&u.fadeTo(500,d.overlayOpacity),e=b.loadImageDimensions(),e=b.getMaxDimensions(e),b.setDimensions(g,e),b.setDimensions(n,e),s=b.getCenter(e),b.setCenter(g,s),b.setFixedPosition(e))}).fail(function(){b.hideLoader();c.error("Error loading image "+a)})},openContent:function(a){"ajax"===k?c.when(c.ajax({url:a,type:"GET"})).done(function(a){b.contentDone(a)}).fail(function(e,d,f){b.hideLoader();c.error("Error "+e.status+" "+f+" while loading "+a)}):
"iframe"===k?c.when(b.loadIframe(a)).done(function(){b.contentDone()}).fail(function(){b.hideLoader();c.error("Error while loading "+a)}):"anchor"===k&&(c(a).length?b.contentDone(c(a).children()):c.error("Can't find anchor "+a))},contentDone:function(a){var e;b.hideLoader();"ajax"===k||"anchor"===k?f.addClass("wb-content").append(a):"iframe"===k&&f.addClass("wb-iframe");g.fadeIn(500,function(){b.bindShortcuts();b.bindWindowResize();d.open()});d.overlay&&u.fadeTo(500,d.overlayOpacity);a=[d.width,d.height];
a=b.getMaxDimensions(a);b.setDimensions(g,a);e=b.getContentDimensions(a);b.setDimensions(f,e);e=b.getCenter(a);b.setCenter(g,e);b.setFixedPosition(a);l=!0},setFixedPosition:function(a){"fixed"===d.position&&(a=b.getCenter(a,!0),b.setCenter(g,a),g.css("position","fixed"))},setAbsolutePosition:function(a){a=b.getCenter(a);b.setCenter(g,a);g.css("position","absolute")},showTitle:function(){var a=d.title||h.attr("title"),e=b.getDimensions(g)[0];a&&(D.width(e).show().children().html(a),g.attr("aria-labelledby",
"wb-title-aria"))},hideTitle:function(){D.hide();g.removeAttr("aria-labelledby")},resizeBox:function(a,b){var d=c.Deferred();g.animate({top:b[0],left:b[1],width:a[0],height:a[1]},250,d.resolve);return d.promise()},getMaxDimensions:function(a){var e=b.getViewport(d.margin),e=[e[0]/a[0],e[1]/a[1]],e=Math.min(e[0],e[1]);return 1>e?[parseInt(a[0]*e,10),parseInt(a[1]*e,10)]:a},getContentDimensions:function(a){var b=parseInt(f.css("marginTop"),10),c=parseInt(f.css("marginRight"),10),d=parseInt(f.css("marginBottom"),
10),g=parseInt(f.css("marginLeft"),10),h=parseInt(f.css("borderTopWidth"),10),i=parseInt(f.css("borderRightWidth"),10),j=parseInt(f.css("borderBottomWidth"),10),k=parseInt(f.css("borderLeftWidth"),10),l=parseInt(f.css("paddingTop"),10),m=parseInt(f.css("paddingRight"),10),n=parseInt(f.css("paddingBottom"),10),o=parseInt(f.css("paddingLeft"),10);return[a[0]-g-c-k-i-o-m,a[1]-b-d-h-j-l-n]},loadImageDimensions:function(){var a;a=h.data("wb-dimensions");a||(a=b.getDimensions(n),h.data("wb-dimensions",
a));return a},getDimensions:function(a){var b=a.is(":visible");b||a.show();var c=[a.width(),a.height()];b||a.hide();return c},setDimensions:function(a,b){a.width(b[0]).height(b[1])},getViewport:function(a){var b=y.width(),c=y.height(),d=2*a;return a?[b-d,c-d]:[b,c]},getScroll:function(){return[A.scrollTop(),A.scrollLeft()]},getCenter:function(a,e){var c=b.getViewport(),f=e?[0,0]:b.getScroll(),g=(c[1]-a[1])/2+f[0],h=(c[0]-a[0])/2+f[1];return[c[1]<a[1]+2*d.margin?d.margin+f[0]:g,c[0]<a[0]+2*d.margin?
d.margin+f[1]:h]},setCenter:function(a,b){a.css({top:b[0]+"px",left:b[1]+"px"})},loadImage:function(a){var b=c.Deferred();n=c('<img role="img" />');n.load(b.resolve).error(b.reject).attr("src",a);return b.promise()},loadIframe:function(a){var b=c.Deferred();G=c('<iframe frameborder="0" />');G.appendTo(f).load(b.resolve).attr("src",a);setTimeout(function(){b.resolve()},1E4);return b.promise()},hideContent:function(){var a=c.Deferred();f.fadeOut(500,a.resolve);return a.promise()},showLoader:function(){h&&
h.css("cursor","wait");z=!0;setTimeout(function(){if(z){v.show();z=!1;var a=b.getDimensions(v),a=b.getCenter(a,!0);b.setCenter(v,a)}},d.loaderDelay)},hideLoader:function(){h&&h.css("cursor","pointer");z=!1;v.hide()},tabNavigation:function(a){a.preventDefault();if(l){var a=g.find(":focus"),b=a.get(0);a.length?b===o.get(0)?j.is(":visible")?j.focus():p.focus():b===j.get(0)?p.focus():b===p.get(0)&&(o.is(":visible")?o.focus():j.is(":visible")&&j.focus()):o.is(":visible")?o.focus():j.is(":visible")?j.focus():
p.focus()}},enter:function(){l&&g.find(":focus").click()},bindShortcuts:function(){A.bind("keydown.wb",function(a){switch(a.which){case 27:b.close();break;case 37:b.prev();break;case 39:b.next();break;case 9:b.tabNavigation(a);break;case 13:b.enter(a)}})},unbindShortcuts:function(){A.unbind("keydown.wb")},setListing:function(){if(r=h.data("wbGroup")||h.data("wb-group")||!1){t=c(i+"[data-wb-group="+r+"]");m=t.index(h);x=t.size();if(1<x&&(0!==m&&(b.enable(j),b.preload(t.eq(m-1))),m!==x-1))b.enable(o),
b.preload(t.eq(m+1));b.positionArrows()}},preload:function(a){a=a.attr("href");-1===c.inArray(a,E)&&(document.createElement("img").src=a,E.push(a))},enable:function(a){a.removeClass("disabled").addClass("enabled").attr("aria-disabled",!1).show()},disable:function(a){a.removeClass("enabled").addClass("disabled").attr("aria-disabled",!0).hide()},getlocalDataOptions:function(){var a=[];c.each(w,function(b,c){var d=h.data(c),f=c.replace("wb-","");void 0!==d&&(a[f]=d)});return a},getContentType:function(a){var b=
"ajax";a.match(/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i)?b="image":d.iframe?b="iframe":/^#/.test(a)&&(b="anchor");return b},hideAnchors:function(){q[i].self.each(function(){var a=c(this).attr("href");/^#/.test(a)&&c(a).hide()})},positionArrows:function(){var a=j.children("span"),b=o.children("span"),c=g.outerHeight(),d=a.height(),f=b.height();a.css("top",(c-d)/2);b.css("top",(c-f)/2)},show:function(a){l=!1;b.disable(j);b.disable(o);p.hide();b.hideTitle();c.when(b.hideContent()).then(function(){var c=b.getDimensions(g);
b.setAbsolutePosition(c);n.remove();b.open(t.eq(a))})},bindListing:function(){j.add(o).bind("click.wb",function(){var a=this===j.get(0)?m-1:m+1;0<=a&&a<x?(d=q[i].options,b.show(a)):c.error("Unknown index "+a+" in group "+r)})},bindOpen:function(){F.delegate(i+":not(#wb-close, #wb-prev, #wb-next)","click.wb",{selector:i},function(a){a.preventDefault();i=a.data.selector;b.open(this)})},bindClose:function(){p.bind("click.wb",function(){b.close()});b.bindCloseOnOverlayClick()},bindCloseOnOverlayClick:function(){u.bind("click.wb",
function(){d.closeOnOverlayClick&&b.close()})},bindWindowResize:function(){var a,e,g;y.bind("resize.wb",function(){p.hide();b.hideTitle();c.when(b.hideContent()).then(function(){a="image"===k?b.loadImageDimensions():[d.width,d.height];a=b.getMaxDimensions(a);e=b.getCenter(a,"fixed"===d.position);c.when(b.resizeBox(a,e)).then(function(){"image"===k?b.setDimensions(n,a):(g=b.getContentDimensions(a),b.setDimensions(f,g));f.fadeIn(500);p.show();b.showTitle();b.positionArrows()})})})},unbindWindowResize:function(){y.unbind("resize.wb")},
create:function(){c('<div id="webbox" role="dialog" tabindex="-1"><div id="wb-content"></div><div id="wb-close" role="button" tabindex="0">\u00d7</div><div id="wb-prev" class="disabled" role="button" aria-disabled="true" tabindex="0"><span>\u00ab</span></div><div id="wb-next" class="disabled" role="button" aria-disabled="true" tabindex="0"><span>\u00bb</span></div><div id="wb-title"><div id="wb-title-aria" /></div></div><div id="wb-loader"><span>\u2605</span></div>').appendTo("body");g=c("#webbox");
p=c("#wb-close");j=c("#wb-prev");o=c("#wb-next");f=c("#wb-content");D=c("#wb-title");v=c("#wb-loader");d.overlay&&(c('<div id="wb-overlay" />').appendTo("body"),u=c("#wb-overlay"));C=!0},destroy:function(){g.add(u).add(v).remove();F.undelegate(".wb");y.unbind(".wb");b.unbindWindowResize();l=C=!1}};c.fn.webbox=function(a){if(b[a])return b[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof a||!a)return b.init.apply(this,arguments);c.error("Method "+a+" does not exist on jQuery webbox plugin")}})(jQuery);